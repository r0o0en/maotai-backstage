<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<title>编辑商品</title>
		<meta name="author" content="" />
		<meta name="keywords" content="" />
		<meta name="description" content="" />

		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="format-detection" content="telephone=no">
		<meta http-equiv="Pragma" content="no-cache" />

		<link rel="stylesheet" href="../../plugins/layui/css/layui.css" media="all">
		<link rel="stylesheet" type="text/css" href="../../plugins/font-awesome/css/font-awesome.css" />
		<link rel="stylesheet" type="text/css" href="../../css/lib.css" />
		<link rel="stylesheet" type="text/css" href="../../css/pages/goodsManagement.css"/>
		
	</head>

	<body>
		<blockquote class="layui-elem-quote layui-text">
			<a target="_blank">操作提示</a>
		</blockquote>

		<form class="layui-form" id="form">
			<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
				<legend>分类</legend>
			</fieldset>
			
			<div class="layui-form-item">
				<label class="layui-form-label"><sup>*</sup>商品分类</label>
				<div class="layui-input-block">
					<select name="categoryId" lay-verify="required"  lay-filter="categoryId"></select>
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label"><sup>*</sup>所属区域</label>
				<div class="layui-input-block">
					<select name="buyType" lay-verify="required">
						<option value="0">现金</option>
						<option value="1">积分</option>
					</select>
				</div>
			</div>
			
			<div class="layui-form-item">
				<label class="layui-form-label"><sup>*</sup>商品排序</label>
				<div class="layui-input-inline">
					<input type="text" value="0" name="sort" placeholder="排序规则" class="layui-input" lay-verify="required|goodsClassSort">
				</div>
				<div class="layui-form-mid layui-word-aux">商品的排序，显示的时候越大的显示在前面，0-100</div>
			</div>
			
			<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
				<legend>基本信息</legend>
			</fieldset>
			

			<div class="layui-form-item">
				<label class="layui-form-label"><sup>*</sup>商品名称</label>
				<div class="layui-input-block">
					<input type="text" name="goodsName" placeholder="商品名称" class="layui-input" lay-verify="required|goodsClassName">
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label"><sup>*</sup>商品PV</label>
				<div class="layui-input-inline">
					<input type="tel" name="pv" placeholder="商品PV" class="layui-input" lay-verify="required|pv">
				</div>
			</div>
			<div class="layui-form-item">
				<div class="layui-inline">
					<label class="layui-form-label"><sup>*</sup>市场价</label>
					<div class="layui-input-inline">
						<input type="text" name="marketPrice" placeholder="市场价"  class="layui-input" lay-verify="required|price">
					</div>
				</div>
				<div class="layui-inline">
					<label class="layui-form-label"><sup>*</sup>售价</label>
					<div class="layui-input-inline">
						<input type="text" name="price" placeholder="售价"  class="layui-input" lay-verify="required|price">
					</div>
				</div>
				<div class="layui-inline">
					<label class="layui-form-label"><sup>*</sup>成本</label>
					<div class="layui-input-inline">
						<input type="text" name="packagePrice" placeholder="成本"  class="layui-input" lay-verify="required|price">
					</div>
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label"><sup>*</sup>库存</label>
				<div class="layui-input-inline">
					<input type="text" name="stock" placeholder="库存"  class="layui-input" lay-verify="required|number">
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label"><sup>*</sup>上下架</label>
				<div class="layui-input-block">
					   <input type="radio" name="status" value="1" title="上架" checked>
					   <input type="radio" name="status" value="0" title="下架" >
				</div>
			</div>
			
			<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
				<legend>图片/详情</legend>
			</fieldset>

			<div class="layui-form-item">
				<label class="layui-form-label">首页图片</label>
				<div class="layui-input-block">
					<div class="layui-upload-drag" id="test10">
						<i class="layui-icon"></i>
						<p>点击上传，或将文件拖拽到此处</p>
					</div>
					<ul class="clearfix upload-image-list upload-defeated" >
						<!--上传失败列表容器-->
						<!--<li class="layui-upload-list">
							<img src="" class="layui-upload-img">
							<p class="img-title">图片</p>
							<p>
								<a class="layui-btn layui-btn-danger layui-btn-xs demo-delete">删除</a>
								<a class="layui-btn layui-btn-mini layui-btn-xs demo-reload">重试</a>
								<br />
								<span style="color: #FF5722;">上传失败</span> 
							</p>
						</li>-->
					</ul>
					<ul class="clearfix upload-image-list upload-succeed" >
						<!--上传成功列表容器-->
					</ul>
					
				</div>
				
			</div>
			
			<!-- 加载编辑器的容器 -->
			<div class="layui-form-item">
				<label class="layui-form-label">编辑</label>
				<div class="layui-input-block">
			    	<script id="newsTxt" name="content" type="text/plain"></script>
				</div>
			</div>

			<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
				<legend>提交</legend>
			</fieldset>

			<!-- 提交 -->
			<div class="layui-form-item">
				<label class="layui-form-label"></label>
				<div class="layui-input-inline">
					<a href="goods-list.html" class="layui-btn" lay-submit lay-filter="formSubmit">立即提交</a>
					<button type="reset" class="layui-btn layui-btn-primary">重置</button>
				</div>
			</div>

		</form>

		<script src="../../plugins/layui/layui.all.js" charset="utf-8"></script>
		<script src="../../js/options.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/navbar.js" type="text/javascript" charset="utf-8"></script>
		
		
		<!-- 配置文件 -->
	    <script type="text/javascript" src="../../plugins/baiduUeditor/ueditor.config.js"></script>
	    <!-- 编辑器源码文件 -->
	    <script type="text/javascript" src="../../plugins/baiduUeditor/ueditor.all.min.js"></script>
		
		<script>
			//百度编辑器
			var url_baidu_edit = getAjaxOrigin() + '/upload/ueUpLoad';
			//上传图片url
			var  url_upLoadImg  = getAjaxOrigin()+'/upload/ueUpLoad' ;
			//新增/编辑商品
			var url_addgoods = getAjaxOrigin() + '/api/admin/goods/goods/addOrMod';
			//获取商品分类列表
			var  url_getGoodsClassList = getAjaxOrigin() + '/api/admin/goods/category/query';
			//获取所有商品分类
			var  url_getGoodsClassAll = getAjaxOrigin() + '/api/admin/goods/category/list';
			//获取商品列表
			var url_getGoodsList = getAjaxOrigin() + '/api/admin/goods/goods/query';
			
			
			//实例化编辑器 
			var ue = UE.getEditor('newsTxt');
//			设置编辑器的内容
//		    ue.setContent('hello');
//		    获取html内容，返回: <p>hello</p>
//		    var html = ue.getContent();
//		    获取纯文本内容，返回: hello
//		    var txt = ue.getContentTxt();
			
			layui.use([], function() {
				//获取url ? 带参
				var urldata = getQueryData();
				//判断 编辑/新增
				if(urldata.id){//带有商品，视为编辑
					ajax({
						//获取指定id的商品
						type:'get',
						url:url_getGoodsList,
						data:{page:1,id:urldata.id},
						success:function(data){
							var goodsinfo = data.data[0];
							console.log('编辑商品',goodsinfo);
							//获取商品分类列表,并传入编辑商品的 categoryId（商品分类Id）
							alertGoodsList(goodsinfo.categoryId);
							alertGoodsForm(goodsinfo);
						}						
					});
				}else{
					alertGoodsList();
				}
				
				function alertGoodsList(selectval){//获取商品分类列表   selectval默认选中的值
					//获取商品分类列表
					ajax({
						type:'get'
//						,data:{page:1}
						,url:url_getGoodsClassAll
						,success:function(data){
							console.log('获取商品分类列表',data);
							var lis = '';
							if(selectval){
								console.log('传入了默认选中',selectval);
								data.data.forEach(function (val,i,arr) {
									if(val.id == selectval){										
										lis +='<option value="'+val.id+'" selected>'+val.categoryName+'</option>';
									}else{										
										lis +='<option value="'+val.id+'">'+val.categoryName+'</option>';
									}
								});	
							}else{
								data.data.forEach(function (val,i,arr) {
									lis +='<option value="'+val.id+'">'+val.categoryName+'</option>';
								});								
							}
							$('select[name="categoryId"]').html(lis);
							//重新渲染
							form.render('select');
							//清空
							lis = null;
						}
					})
				}
				
				function alertGoodsForm(data) {//根据get的商品信息更新form  data:ajax获取到的商品信息,类型为object
					$('form').prepend('<input type="hidden" title="当前编辑的商品ID" name="id" value="'+data.id+'" />');
					//所属区域
					var buyType = [{val:0,name:'现金'},{val:1,name:'积分'}],
						buyTypeHtml = '';
					$.each(buyType,function (i,e) {
						buyTypeHtml +='<option value="'+e.val+'" '+( e.val == data.buyType ? 'selected' : '') +'>'+e.name+'</option>';
					})
					$('select[name="buyType"]').html(buyTypeHtml);
					//重新渲染
					form.render('select');
					//商品排序
					$('input[name="buyType"]').attr('value',data.sort);
					//商品名称
					$('input[name="goodsName"]').attr('value',data.goodsName);
					//pv
					$('input[name="pv"]').attr('value',data.pv);
					//市场价
					$('input[name="marketPrice"]').attr('value',data.marketPrice);
					//售价
					$('input[name="price"]').attr('value',data.price);
					//成本价
					$('input[name="packagePrice"]').attr('value',data.packagePrice);
					//库存
					$('input[name="stock"]').attr('value',data.stock);
					//上下架
					$('input[type="radio"]').removeAttr('checked');
					$('input[name="status"][value="'+data.status+'"]').attr('checked','checked').prop("checked", "checked");
					form.render('radio');
					//图片
					$.each(getImgurl(data.goodsPics),function (i,e) {
						$('.upload-succeed').append('<li class="layui-upload-list"><img src="'+e+'" class="layui-upload-img"><p><a class="layui-btn layui-btn-danger layui-btn-xs demo-delete">删除</a></p></li>')
					})
					//编辑器内容
//					console.log(data.memo);
//					console.log(HtmlUtil.htmlDecode(data.memo));
//					console.log(ue.setContent);
					ue.ready(function() {
					    ue.setContent(HtmlUtil.htmlDecode(data.memo), true);
					});
					
				}
				
				
				
				//存储上传数据，上传失败后用来展示内容
				var upload_arr=[];
				//拖拽上传
				var uploadInst = upload.render({
					elem: '#test10'
					,url: url_baidu_edit
					,field:"upfile"
					,before: function(obj){
					  upload_arr=[];
				      //预读本地文件示例，不支持ie8
				      obj.preview(function(index, file, result){
				      	upload_arr.push([index, file, result]);
				      	console.log(upload_arr);
				      });
				    }
					,done: function(res){
				      //如果上传失败
				      if(res.code > 0){
				        return layer.msg(res.original+'上传失败');
				      }
				      //上传成功
				      $('.upload-succeed').append('<li class="layui-upload-list"><img src="'+res.url+'" class="layui-upload-img"><p class="img-title">'+res.original+'</p><p><a class="layui-btn layui-btn-danger layui-btn-xs demo-delete">删除</a></p></li>')
				    }
				    ,error: function(i){
				    	var that;
				    	console.log(i,/^[0-9]+\-[0-9]+$/ig.test(i));
				    	if(/^[0-9]$/ig.test(i)){
				    		if(upload_arr.length>i){
					    		that = upload_arr[i];
					    		
					    	}	
				    	}else if(/^[0-9]+\-[0-9]+$/ig.test(i)){
				    		upload_arr.forEach(function(val,j,arr){
				    			if(val[0].split('-')[1] == j){
				    				that = val;
				    			}
				    		});
				    	}
				    	if(that){
				    		$('.upload-defeated').append('<li class="layui-upload-list"><img src="'+that[2]+'" class="layui-upload-img"><p class="img-title">'+that[1].name+'</p><p><a class="layui-btn layui-btn-mini layui-btn-xs demo-reload">重试</a><br /><span style="color: #FF5722;">上传失败</span> </p></li>');
				    	}
				    	that = null;
				    }
				});
				
				$('.upload-defeated').on('click','.demo-reload', function(){//重新上传
					$('.upload-defeated').empty();
				    uploadInst.upload();
				});
				
				$('.upload-succeed').on('click','.demo-delete',function (e) {//在已上传的列表中删除点击的li容器（最后提交拼接每个li中的img连接）
					var _this = this ;
					layer.alert('确认图片删除嘛?',{
						btn:['删除','取消']
						,yes:function(index){
							$(_this).parents('li.layui-upload-list').remove();
							layer.close(index);
						}
					})
				})
				
				

				//监听提交
				form.on('submit(formSubmit)', function(data) {
					var d = data.field;
					//获取上传成功列表,拼接字符串
					var imgstr = '';
					$('.upload-succeed img').each(function (i,e) {
						if(i!=0){
							imgstr += ',';
						}
						imgstr += $(e).attr('src');
					});
					d.goodsPics = imgstr;
					
					//获取百度编辑器内容
					var editor = HtmlUtil.htmlEncode(ue.getContent());
					d.memo = editor;
					ajax({
							info: '更新商品',
							type: 'get',
							url: url_addgoods,
							data: d,
							success: function(data) {
								layer.msg('上传成功');
								// 重置
								$('.upload-image-list.upload-succeed').empty();
								$('button[type="reset"]').trigger('click');
								openPage('商品列表','pages/goodsManagement/goods-list.html');
								setTimeout(function () {									
									CloseWebPage();
								},100);
							}
					})
					return false;
				});

			})
		</script>

	</body>

</html>